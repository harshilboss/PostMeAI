<!DOCTYPE html>
<html>
<head>
  <title>Seamless Voice Chat</title>
</head>
<body>
  <h1>🎙️ Talking to GPT...</h1>
  <div id="status">Starting...</div>

  <script>
    const status = document.getElementById("status");
    let mediaRecorder;
    let stream;

    async function startMicLoop() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        status.textContent = "🎤 Microphone ready. Recording...";
        recordChunk();
      } catch (e) {
        status.textContent = `❌ Microphone access denied: ${e.message}`;
      }
    }

    function recordChunk() {
      let chunks = [];
      mediaRecorder = new MediaRecorder(stream);
      mediaRecorder.ondataavailable = e => chunks.push(e.data);

      mediaRecorder.onstop = async () => {
        const blob = new Blob(chunks, { type: 'audio/webm' });
        const formData = new FormData();
        formData.append("audio", blob);

        status.textContent = "🧠 Transcribing...";

        try {
          const transRes = await fetch("https://aigen-9t0e.onrender.com/transcribe", {
            method: "POST",
            body: formData
          });

          const result = await transRes.json();
          const text = result?.text;

          if (!text || typeof text !== "string" || text.trim() === "") {
            status.textContent = result?.error
              ? `❌ Server error: ${result.error}`
              : "🕐 No speech detected. Restarting...";
            return setTimeout(recordChunk, 1000);
          }

          status.textContent = `🗣️ You: ${text}\n🤖 Thinking...`;

          const gptRes = await fetch("https://aigen-9t0e.onrender.com/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message: text })
          });

          const gptData = await gptRes.json();
          const response = gptData?.response || "🤖 GPT: No response";
          status.textContent = `🗣️ You: ${text}\n🤖 GPT: ${response}`;

          speak(response, () => setTimeout(recordChunk, 500));
        } catch (e) {
          status.textContent = `❌ Error: ${e.message}`;
          console.error("Error:", e);
          setTimeout(recordChunk, 1000);
        }
      };

      mediaRecorder.start();
      setTimeout(() => mediaRecorder.stop(), 5000); // Record for 5 seconds
    }

    function speak(text, onDone) {
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.onend = onDone;
      speechSynthesis.speak(utterance);
    }

    startMicLoop();
  </script>
</body>
</html>
